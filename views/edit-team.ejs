<%- include('partials/header', { title: 'edit-team' }) %>
<body>
  <%
    // Mock Data for Testing
    const teams = [
      { id: 1, name: 'Team Alpha', members: [] },
      { id: 2, name: 'Team Bravo', members: [] },
      { id: 3, name: 'Team Charlie', members: [] }
    ];

    const availableStudents = [
      { id: 1, name: 'Kevin' }, 
      { id: 2, name: 'Joyal' }, 
      { id: 3, name: 'Aditi' },
      { id: 4, name: 'Owen' }, 
      { id: 5, name: 'Oussama' }, 
      { id: 6, name: 'Jonathan' },
      { id: 7, name: 'Emily' },
      { id: 8, name: 'Michael' },
      { id: 9, name: 'Sophia' },
      { id: 10, name: 'James' },
      { id: 11, name: 'Olivia' }
    ];

    let removedStudents = [];
    let newStudents = [];
  %>

  <!-- Container to center the form -->
  <div class="container mt-5 mb-5 d-flex justify-content-center align-items-center">
    <!-- Card to hold the form -->
    <div class="card bg-light rounded p-5" style="width: 100%; max-width: 900px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
      <h2 class="text-center mb-4">Edit Teams</h2>

      <!-- Form to edit the team -->
      <form id="editTeamForm" onsubmit="return showConfirmation()">
        <!-- Team selection dropdown -->
        <div class="form-group mx-5 my-4">
          <label for="teamSelect">Select Team</label>
          <select id="teamSelect" name="team" class="form-control" style="max-width: 700px;" onchange="switchTeam()">
            <% teams.forEach(function(team) { %>
              <option value="<%= team.id %>"><%= team.name %></option>
            <% }) %>
          </select>
        </div>

        <!-- Input to change the team name -->
        <div class="form-group mx-5 my-4">
          <label for="teamName">Change Team Name</label>
          <input type="text" id="teamName" name="teamName" class="form-control" style="max-width: 700px;">
        </div>

        <!-- Row to separate student lists and members -->
        <div class="row">
          <!-- Available Students List -->
          <div class="mx-5 col-md-5">
            <h5 class="mb-3">List of Students</h5>
            <input type="text" id="studentSearch" class="form-control mb-3" placeholder="Search for students" style="max-width: 300px;">
            <div class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
              <ul id="studentList" class="list-group mb-0">
                <% availableStudents.forEach(function(student) { %>
                  <li class="list-group-item d-flex align-items-center">
                    <input type="checkbox" id="student_<%= student.id %>" class="mr-2" name="students[]" value="<%= student.id %>">
                    <label for="student_<%= student.id %>" class="mb-0"><%= student.name %></label>
                  </li>
                <% }) %>
              </ul>
            </div>
          </div>

          <!-- Current Team Members and New Students -->
          <div class="col-md-4">
            <h5 class="mb-3">Current Team Members</h5>
            <div class="border rounded p-2 mb-3" style="max-height: 300px; overflow-y: auto;">
              <ul id="currentMembersList" class="list-group mb-0"></ul>
            </div>

            <!-- Centered Buttons with Reduced Width -->
            <div class="d-flex justify-content-center mb-3">
              <button type="button" class="btn btn-outline-danger btn-sm" style="width: 150px;" onclick="removeAllMembers()">Remove All</button>
            </div>

            <h5 class="mb-3">New Students</h5>
            <div class="border rounded p-2 mb-3" style="max-height: 300px; overflow-y: auto;">
              <ul id="newStudentsList" class="list-group mb-0"></ul>
            </div>

            <!-- Centered Buttons with Reduced Width -->
            <div class="d-flex justify-content-center">
              <button type="button" class="btn btn-outline-success btn-sm" style="width: 150px;" onclick="saveNewStudents()">Save New Students</button>
            </div>
          </div>
        </div>

        <!-- Save Changes Button -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>

        <!-- Confirmation message -->
        <div id="confirmationMessage" class="alert alert-success mt-3" style="display: none;">
          Team changes have been successfully saved!
        </div>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    let teams = <%- JSON.stringify(teams) %>;
    let availableStudents = <%- JSON.stringify(availableStudents) %>;
    let removedStudents = [];
    let newStudents = [];

    function showConfirmation() {
      event.preventDefault();
      document.getElementById('confirmationMessage').style.display = 'block';
      document.getElementById('editTeamForm').reset();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return false;
    }

    function switchTeam() {
      let teamId = document.getElementById('teamSelect').value;
      let selectedTeam = teams.find(team => team.id == teamId);
      document.getElementById('teamName').value = selectedTeam.name;
      let memberList = document.getElementById('currentMembersList');
      memberList.innerHTML = '';
      selectedTeam.members.forEach(member => {
        let li = document.createElement('li');
        li.classList.add('list-group-item');
        li.innerHTML = `${member.name} <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMember(${member.id})">Remove</button>`;
        memberList.appendChild(li);
      });
    }

    function addNewStudent(studentId, studentName) {
      if (!newStudents.includes(studentId)) {
        newStudents.push(studentId);
        let newStudentList = document.getElementById('newStudentsList');
        let li = document.createElement('li');
        li.classList.add('list-group-item');
        li.innerHTML = `${studentName} <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeNewStudent(${studentId})">Remove</button>`;
        newStudentList.appendChild(li);
      }
    }

    function removeNewStudent(studentId) {
      newStudents = newStudents.filter(id => id !== studentId);
      let studentElement = document.querySelector(`#newStudentsList li`);
      if (studentElement) studentElement.remove();
      let studentCheckbox = document.getElementById('student_' + studentId);
      if (studentCheckbox) studentCheckbox.checked = false;
    }

    function saveNewStudents() {
      if (newStudents.length === 0) {
        alert('No new students to save.');
        return;
      }
      newStudents.forEach(studentId => {
        let studentName = document.querySelector(`#studentItem_${studentId} label`).textContent;
        addTeamMember(studentId, studentName);
      });
      newStudents = [];
      document.getElementById('newStudentsList').innerHTML = '';
    }

    function addTeamMember(studentId, studentName) {
      let currentMembersList = document.getElementById('currentMembersList');
      let li = document.createElement('li');
      li.classList.add('list-group-item');
      li.innerHTML = `${studentName} <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMember(${studentId})">Remove</button>`;
      currentMembersList.appendChild(li);
    }

    function removeMember(memberId) {
      let memberElement = document.querySelector(`#currentMembersList li`);
      if (memberElement) memberElement.remove();
      removedStudents.push(memberId);
    }

    function removeAllMembers() {
      document.getElementById('currentMembersList').innerHTML = '';
      removedStudents = [];
    }

    document.addEventListener('DOMContentLoaded', switchTeam);
  </script>

  <!-- Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>

<%- include('partials/footer') %>
